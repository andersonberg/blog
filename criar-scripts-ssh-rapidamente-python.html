<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Como Criar Scripts SSH Rapidamente com Python | Anderson Berg</title>

  <meta name="author" content="Anderson Berg">
  <meta name="description" content="">
  <meta name="robots" content="">

  <meta property="og:site_name" content="Anderson Berg">
  <meta property="og:type" content="website">



  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="icon" type="image/x-icon" href="./favicon.ico">

  <link rel="alternate" type="application/rss+xml" title="Anderson Berg &raquo; Feed" href="/">
  <link rel="canonical" href="">

    <link rel="stylesheet" href="https://unpkg.com/purecss@1.0.0/build/pure-min.css" integrity="sha384-nn4HPE8lTHyVtfCBi5yW9d20FjT8BJwUXyWZT9InLYax14RDjBj46LmSztkmNP9w" crossorigin="anonymous">
      <link rel="stylesheet" href="./theme/css/styles.min.css?0830b1e2">
</head>
<body>
  <div class="Page pure-g is-fullEntry">
<div class="PageHeader pure-u-1">
    <nav class="pure-menu pure-menu-open pure-menu-horizontal">

        <a
			href="./index.html"
            title="Home page"
            class="PageHeader-link pure-menu-heading pure-menu-link">Anderson<span class="u-highlighted">Berg</a>

			<ul class="PageHeader-menu pure-menu-list">
                    <li class="pure-menu-item">
                        <a href="./pages/contato.html" class="PageHeader-menu-link pure-menu-link">Contato</a>
                    </li>

			</ul>
    </nav>
</div>
    <div class="PageContent pure-u-1">


<article class="Article u-box" itemscope="" itemtype="http://schema.org/BlogPosting">
    <span itemprop="mainEntityOfPage">
        <header>
            <h1 class="Article-title" itemprop="headline name">
                Como Criar Scripts SSH Rapidamente com Python
            </h1>

                <p class="Article-meta">
                    Por <span class="Article-author" itemprop="author">Anderson Berg</span>.

                    <span class="Article-pubDate">
                        Publicado em
                        <time datetime="2013-05-20T13:45:46-03:00" itemprop="datePublished">20 May, 2013</time>
                    </span>
                </p>
        </header>

        <div class="Article-content" itemprop="articleBody">
<img
        src="images/acesso-remoto-a-servidores.jpg"
        alt="None"
        class="representative-image"
        width="180"
        height="180" />
                <p>Às vezes é necessário trabalhar com <strong>vários</strong> dispositivos ligados em <strong>rede</strong>, quer sejam computadores, roteadores ou outros tipos de equipamentos.</p>
<p>Em muitas ocasiões precisamos enviar <strong>comandos</strong> e <strong>instruções</strong> para estes equipamentos. Isso geralmente é feito através do envio de comandos ou dados via <strong>SSH</strong>.</p>
<p>Tudo bem entrar em um terminal e enviar um comando ou dois pra um equipamento ou outro.</p>
<p>Mas e se forem <strong>milhares</strong> de dispositivos interconectados?</p>
<p>Ou se são <strong>dezenas</strong> ou <strong>centenas</strong> de instruções em série?</p>
<p>E se estas duas situações ocorrem <strong>juntas</strong>?</p>
<p>Nesses casos é preciso criar scripts que façam tudo automatizado.</p>
<p>Neste artigo vou compartilhar minha experiência com o Paramiko, um módulo Python que fornece uma interface ao protocolo SSH2.</p>
<p>SSH é um protocolo de rede criptografado que realiza conexão segura entre computadores e permite executar comandos remotamente. Em diversas situações é necessário automatizar o processo de conexão e execução de comandos em um computador remoto.</p>
<h2>Como instalar o Paramiko</h2>
<p>Para instalar o Paramiko é necessário instalar antes o PyCrypto, que pode ser encontrado via easy_install ou no repositório da sua distribuição Linux. Encontrei algumas dificuldades para instalar o pycrypto no Windows, por sorte existem alguns binários compilados do pycrypto: <a href="http://www.voidspace.org.uk/python/modules.shtml#pycrypto">http://www.voidspace.org.uk/python/modules.shtml#pycrypto</a></p>
<p>Depois é só instalar o paramiko via easy_install ou procurando no repositório da distro Linux.</p>
<p>O paramiko tem uma classe base que fornece toda a interface para comunicação: <strong><em>paramiko.SSHClient</em></strong>. Para criar um objeto e criar uma conexão com um servidor é bem simples:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">paramiko</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anderson&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>

<p>Neste exemplo, a função 'connect' está conectando ao servidor SSH local, passando nome de usuário e senha através dos par&acirc;metros 'username' e 'password', respectivamente.</p>
<p>Quando você conecta em um servidor ssh pela primeira vez, uma chave é automaticamente armazenada em disco num arquivo chamado "<strong><em>.ssh/known_hosts</em></strong>" na sua pasta home. Para isto é preciso o usuário, manualmente, aceitar o armazenamento da chave do servidor, confirmando a confiabilidade deste. Para fazermos isso automaticamente através do Paramiko, utilizamos o objeto "set_missing_host_key_policy", passando "<strong><em>paramiko.AutoAddPolicy()</em></strong>" como parâmetro para aceitar automaticamente as chaves. Então, nosso código anterior pode ser modificado:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">paramiko</span>
<span class="n">ssh</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s1">&#39;anderson&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>

<p>Tenha o cuidado de somente utilizar este artifício com servidores que você confia.</p>
<h2>Enviando comandos via ssh</h2>
<p>Já aprendemos como conectar em um computador remotamente via ssh. Agora vamos ver como enviar comandos e receber os resultados destes comandos. Isto é feito com o método "exec_command" do SSHClient(). Este método retorna uma tupla de objetos (stdin, stdout, stderr) que você pode ler (no caso do stdout e stderr) ou escrever (stdin). A sintaxe para executar um comando é a seguinte:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s1">&#39;ls</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>
</td></tr></table>

<p>Que vai enviar o comando 'ls' para listar os arquivos do diretório atual. Para exibir o retorno deste comando podemos ler o conteúdo do objeto stdout e, em seguida, fechar a conexão ssh:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="nb">print</span> <span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">ssh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>

<p>Em alguns casos precisamos enviar outras informações para execução do comando, como por exemplo uma senha de administrador. Podemos fazer isto escrevendo no objeto stdin.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><code><span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh</span><span class="o">.</span><span class="n">exec_command</span><span class="p">(</span><span class="s1">&#39;sudo fdisk -l</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;1234</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">stdout</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
</code></pre></div>
</td></tr></table>

<p>O retorno dos comando pode ser tratado com as poderosas ferramentas de manipulação de string de Python, ou ainda filtradas com expressões regulares, dando ainda mais opções ao programador na hora de criar um script completo. Em outro post darei mais detalhes sobre a utilização do Paramiko.</p>
        </div>
    </span>


            <div class="Article-tags">
                <span class="Article-tagLabel">Tags:</span>
                <span itemprop="keywords">
                        <a
                            href="./tag/ssh.html"
                            title="Leia mais sobre"
                            class="Article-tagLink">ssh</a>
                        <a
                            href="./tag/script.html"
                            title="Leia mais sobre"
                            class="Article-tagLink">script</a>
                </span>
            </div>

        <div class="Article-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = "pythonize.org";
        var disqus_identifier = "criar-scripts-ssh-rapidamente-python.html";

        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
        </div>
</article>
    </div>

<footer class="PageFooter pure-u-1">
    <div class="u-box">
        <p>O conteúdo deste blog está sob a licença
          <a
              class="PageFooter-link"
              href=""
              title=""
              rel="nofollow"></a>.</p>

        <p>O código está disponível em
          <a
              class="PageFooter-link"
              href=""
              title="Contribute!"
              rel="nofollow"></a>.</p>
    </div>
</footer>  </div>

    <script>
        (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
        function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
        e=o.createElement(i);r=o.getElementsByTagName(i)[0];
        e.src='//www.google-analytics.com/analytics.js';
        r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
        ga('create','UA-25538784-1');ga('send','pageview');
    </script>
</body>
</html>