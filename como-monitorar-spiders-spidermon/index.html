<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.28b715d0c0238008b3e5.css" id="gatsby-global-css">:root{--reach-skip-nav:1}[data-reach-skip-nav-link]{border:0;clip:rect(0 0 0 0);height:1px;width:1px;margin:-1px;padding:0;overflow:hidden;position:absolute}[data-reach-skip-nav-link]:focus{padding:1rem;position:fixed;top:10px;left:10px;background:#fff;z-index:1;width:auto;height:auto;clip:auto}</style><meta name="generator" content="Gatsby 2.31.1"/><title data-react-helmet="true">Como monitorar web-crawlers com Spidermon | Anderson Berg</title><meta data-react-helmet="true" name="description" content="Uma das etapas mais importantes do web-scraping (ou raspagem de dados) é garantir a qualidade das informações extraídas. Devido ao grande…"/><meta data-react-helmet="true" property="og:title" content="Como monitorar web-crawlers com Spidermon"/><meta data-react-helmet="true" property="og:description" content="Uma das etapas mais importantes do web-scraping (ou raspagem de dados) é garantir a qualidade das informações extraídas. Devido ao grande…"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" name="twitter:creator" content="Anderson Berg"/><meta data-react-helmet="true" name="twitter:title" content="Como monitorar web-crawlers com Spidermon"/><meta data-react-helmet="true" name="twitter:description" content="Uma das etapas mais importantes do web-scraping (ou raspagem de dados) é garantir a qualidade das informações extraídas. Devido ao grande…"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><link as="script" rel="preload" href="/styles-9411612e31e4f14527d1.js"/><link as="script" rel="preload" href="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-0edab85ce55c0548d50d.js"/><link as="script" rel="preload" href="/app-daa015120a5471449e2c.js"/><link as="script" rel="preload" href="/commons-e4855faf0c374b89b985.js"/><link as="script" rel="preload" href="/framework-3e6dec6139dadaa7d0c7.js"/><link as="script" rel="preload" href="/webpack-runtime-38ea2b586afb87ab3a8f.js"/><link as="fetch" rel="preload" href="/page-data/como-monitorar-spiders-spidermon/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/2744905544.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/3090755652.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/386998304.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/764694655.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><script>(function() { try {
  var mode = localStorage.getItem('theme-ui-color-mode');
  if (!mode) return
  document.body.classList.add('theme-ui-' + mode);
} catch (e) {} })();</script><div id="___gatsby"><style data-emotion-css="zk5xvy">body{--theme-ui-colors-text:#282c35;--theme-ui-colors-background:#fff;--theme-ui-colors-primary:#007acc;--theme-ui-colors-secondary:#1B1F23;--theme-ui-colors-muted:hsla(0,0%,0%,0.2);--theme-ui-colors-highlight:rgba(255,229,100,0.2);--theme-ui-colors-heading:#282c35;--theme-ui-colors-prism-background:#011627;--theme-ui-colors-prism-comment:#809393;--theme-ui-colors-prism-string:#addb67;--theme-ui-colors-prism-var:#d6deeb;--theme-ui-colors-prism-number:#f78c6c;--theme-ui-colors-prism-constant:#82aaff;--theme-ui-colors-prism-punctuation:#c792ea;--theme-ui-colors-prism-className:#ffc98b;--theme-ui-colors-prism-tag:#ffa7c4;--theme-ui-colors-prism-boolean:#ff5874;--theme-ui-colors-prism-property:#80cbc4;--theme-ui-colors-prism-namespace:#b2ccd6;--theme-ui-colors-prism-highlight:hsla(207,95%,15%,1);color:var(--theme-ui-colors-text,#282c35);background-color:var(--theme-ui-colors-background,#fff);}body.theme-ui-dark{--theme-ui-colors-text:rgba(255,255,255,0.86);--theme-ui-colors-background:#232129;--theme-ui-colors-primary:#D9BAE8;--theme-ui-colors-secondary:rgba(255,255,255,0.86);--theme-ui-colors-muted:hsla(0,0%,100%,0.2);--theme-ui-colors-highlight:#663399;--theme-ui-colors-heading:#fff;}</style><style data-emotion-css="8ir1vi">*{box-sizing:border-box;}body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;}</style><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><style data-emotion-css="ocpejr">.css-ocpejr{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;}</style><div class="css-ocpejr"><header><style data-emotion-css="o7eq5i">.css-o7eq5i{color:var(--theme-ui-colors-primary,#007acc);}</style><a class="css-o7eq5i" href="#reach-skip-nav" data-reach-skip-link="" data-reach-skip-nav-link="">Skip to content</a><style data-emotion-css="1ufxd81">.css-1ufxd81{max-width:672px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;}</style><div class="css-1ufxd81"><style data-emotion-css="4c94nt">.css-4c94nt{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;margin-bottom:32px;}</style><div class="css-4c94nt"><style data-emotion-css="1qd1r5f">.css-1qd1r5f{margin-top:0;margin-bottom:0;}</style><p class="css-1qd1r5f"><style data-emotion-css="1febbns">.css-1febbns{box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,#007acc);}</style><style data-emotion-css="1a7e4c0">.css-1a7e4c0{color:var(--theme-ui-colors-primary,#007acc);box-shadow:none;-webkit-text-decoration:none;text-decoration:none;color:var(--theme-ui-colors-primary,#007acc);}</style><a class="css-1a7e4c0" href="/">Anderson Berg</a></p></div></div></header><div id="reach-skip-nav" data-reach-skip-nav-content=""></div><div><style data-emotion-css="1in33uw">.css-1in33uw{max-width:672px;margin-left:auto;margin-right:auto;padding-left:16px;padding-right:16px;padding-top:32px;padding-bottom:32px;}</style><div class="css-1in33uw"><main><article><header><h1 class="css-0">Como monitorar web-crawlers com Spidermon</h1><style data-emotion-css="1h1xv8c">.css-1h1xv8c{font-size:14px;margin-top:-16px;margin-bottom:16px;}</style><style data-emotion-css="dv5tmu">.css-dv5tmu{font-size:14px;margin-top:-16px;margin-bottom:16px;}.css-dv5tmu code{font-size:inherit;}</style><p class="css-dv5tmu">September 06, 2020</p></header><section><style data-emotion-css="1ek8oqb">.css-1ek8oqb code{font-size:inherit;}</style><p class="css-1ek8oqb">Uma das etapas mais importantes do web-scraping (ou raspagem de dados) é garantir a qualidade das informações extraídas. Devido ao grande volume de dados que podem ser coletados por um spider, é bem complicado analisar tudo manualmente. Porém existem ferramentas para auxiliar nesse processo que vão diminuir muito o trabalho de quem faz esse tipo de análise. Uma dessas ferramentas é o Spidermon, que vou apresentar neste artigo.</p><p class="css-1ek8oqb">Spidermon é uma extensão do Scrapy usado para monitorar spiders. É um framework bem robusto e, pra mim, indispensável nos projetos que trabalho. Com ele é possível validar a execução ou os resultados produzidos por spiders. Além disso, você pode criar relatórios e enviar notificações via slack ou e-mail, por exemplo.</p><p class="css-1ek8oqb">Para poder ver o Spidermon em ação, vamos começar criando um spider bem simples. Vamos supor que queremos extrair título do livro e respectivo ranking da seguinte página: <a href="https://www.goodreads.com/list/show/3.Best_Science_Fiction_Fantasy_Books/" class="css-o7eq5i">https://www.goodreads.com/list/show/3.Best_Science_Fiction_Fantasy_Books/</a></p><p class="css-1ek8oqb">Nosso spider seria assim:</p><style data-emotion-css="f4r2wo">.css-f4r2wo{font-family:Menlo,monospace;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;margin-bottom:8px;color:white;background-color:var(--theme-ui-colors-prism-background,#011627);overflow:auto;border-radius:10px;padding:16px;}.css-f4r2wo .attr-name{font-style:italic;}.css-f4r2wo .comment{color:var(--theme-ui-colors-prism-comment,#809393);}.css-f4r2wo .attr-name,.css-f4r2wo .string,.css-f4r2wo .url{color:var(--theme-ui-colors-prism-string,#addb67);}.css-f4r2wo .variable{color:var(--theme-ui-colors-prism-var,#d6deeb);}.css-f4r2wo .number{color:var(--theme-ui-colors-prism-number,#f78c6c);}.css-f4r2wo .builtin,.css-f4r2wo .char,.css-f4r2wo .constant,.css-f4r2wo .function{color:var(--theme-ui-colors-prism-constant,#82aaff);}.css-f4r2wo .punctuation,.css-f4r2wo .selector,.css-f4r2wo .doctype{color:var(--theme-ui-colors-prism-punctuation,#c792ea);}.css-f4r2wo .class-name{color:var(--theme-ui-colors-prism-className,#ffc98b);}.css-f4r2wo .tag,.css-f4r2wo .operator,.css-f4r2wo .keyword{color:var(--theme-ui-colors-prism-tag,#ffa7c4);}.css-f4r2wo .boolean{color:var(--theme-ui-colors-prism-boolean,#ff5874);}.css-f4r2wo .property{color:var(--theme-ui-colors-prism-property,#80cbc4);}.css-f4r2wo .namespace{color:var(--theme-ui-colors-prism-namespace,#b2ccd6);}.css-f4r2wo .highlight{background:hsla(0,0%,40%,.5);}</style><style data-emotion-css="1q7q4hh">.css-1q7q4hh{font-family:Menlo,monospace;font-size:inherit;}</style><style data-emotion-css="1eu4vb7">.css-1eu4vb7{font-family:Menlo,monospace;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;margin-bottom:8px;color:white;background-color:var(--theme-ui-colors-prism-background,#011627);overflow:auto;border-radius:10px;padding:16px;font-family:Menlo,monospace;font-size:inherit;}.css-1eu4vb7 .attr-name{font-style:italic;}.css-1eu4vb7 .comment{color:var(--theme-ui-colors-prism-comment,#809393);}.css-1eu4vb7 .attr-name,.css-1eu4vb7 .string,.css-1eu4vb7 .url{color:var(--theme-ui-colors-prism-string,#addb67);}.css-1eu4vb7 .variable{color:var(--theme-ui-colors-prism-var,#d6deeb);}.css-1eu4vb7 .number{color:var(--theme-ui-colors-prism-number,#f78c6c);}.css-1eu4vb7 .builtin,.css-1eu4vb7 .char,.css-1eu4vb7 .constant,.css-1eu4vb7 .function{color:var(--theme-ui-colors-prism-constant,#82aaff);}.css-1eu4vb7 .punctuation,.css-1eu4vb7 .selector,.css-1eu4vb7 .doctype{color:var(--theme-ui-colors-prism-punctuation,#c792ea);}.css-1eu4vb7 .class-name{color:var(--theme-ui-colors-prism-className,#ffc98b);}.css-1eu4vb7 .tag,.css-1eu4vb7 .operator,.css-1eu4vb7 .keyword{color:var(--theme-ui-colors-prism-tag,#ffa7c4);}.css-1eu4vb7 .boolean{color:var(--theme-ui-colors-prism-boolean,#ff5874);}.css-1eu4vb7 .property{color:var(--theme-ui-colors-prism-property,#80cbc4);}.css-1eu4vb7 .namespace{color:var(--theme-ui-colors-prism-namespace,#b2ccd6);}.css-1eu4vb7 .highlight{background:hsla(0,0%,40%,.5);}</style><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">BooksSpider</span><span class="token punctuation">(</span><span class="token plain">scrapy</span><span class="token punctuation">.</span><span class="token plain">Spider</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    name </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;books&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    allowed_domains </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;goodreads.com&#x27;</span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    start_urls </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&#x27;https://www.goodreads.com/list/show/3.Best_Science_Fiction_Fantasy_Books/&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><style data-emotion-css="1baulvz">.css-1baulvz{display:inline-block;}</style><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">,</span><span class="token plain"> response</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        books_list </span><span class="token operator">=</span><span class="token plain"> response</span><span class="token punctuation">.</span><span class="token plain">css</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token string">&#x27;tr[itemtype=&quot;http://schema.org/Book&quot;]&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">for</span><span class="token plain"> book </span><span class="token keyword">in</span><span class="token plain"> books_list</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token keyword">yield</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&#x27;title&#x27;</span><span class="token punctuation">:</span><span class="token plain"> book</span><span class="token punctuation">.</span><span class="token plain">css</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token string">&#x27;.bookTitle span[itemprop=&quot;name&quot;]::text&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                </span><span class="token string">&#x27;rating&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token builtin">float</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    book</span><span class="token punctuation">.</span><span class="token plain">css</span><span class="token punctuation">(</span><span class="token string">&#x27;.minirating::text&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                    </span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">re_first</span><span class="token punctuation">(</span><span class="token string">r&#x27;\d[\d.]*&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">yield</span><span class="token plain"> scrapy</span><span class="token punctuation">.</span><span class="token plain">Request</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            response</span><span class="token punctuation">.</span><span class="token plain">urljoin</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">                response</span><span class="token punctuation">.</span><span class="token plain">css</span><span class="token punctuation">(</span><span class="token string">&#x27;.next_page::attr(href)&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token plain">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span></div></pre><p class="css-1ek8oqb">Antes de criar o primeiro monitor, habilite o Spidermon nas configurações do projeto. É bem simples, adicione as seguintes linhas no arquivo settings.py do seu projeto scrapy:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token plain">SPIDERMON_ENABLED </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">True</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">EXTENSIONS </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;spidermon.contrib.scrapy.extensions.Spidermon&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">500</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><style data-emotion-css="h7w91b">.css-h7w91b{pointer-events:painted;}.css-h7w91b a{visibility:hidden;}.css-h7w91b:hover a{visibility:visible;}</style><h2 id="criando-monitores" class="css-h7w91b"><style data-emotion-css="vvm4x1">.css-vvm4x1{margin-left:-20px;padding-right:4px;color:var(--theme-ui-colors-primary,#007acc);}</style><a href="#criando-monitores" aria-label="Criando monitores" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Criando monitores</h2><p class="css-1ek8oqb">Agora para que o Spidermon comece a monitorar os resultados, precisamos criar monitores. Monitores no Spidermon são baseados no unittest, portanto são basicamente casos de teste executados em determinado momento da execução do spider. Os monitores por sua vez, podem ser agrupados em um MonitorSuite. As classes MonitorSuite são importantes para definir quais monitores serão executados e quais ações terão lugar antes e depois que o grupo de monitores terminar seu trabalho.</p><p class="css-1ek8oqb">Vamos entender melhor com um exemplo: Queremos garantir que o spider vai extrair pelo menos 10 itens. Através dos stats finais do spider, temos acesso a um atributo chamado <style data-emotion-css="1pnz7gf">.css-1pnz7gf{border-radius:0.3em;color:var(--theme-ui-colors-secondary,#1B1F23);background-color:var(--theme-ui-colors-highlight,rgba(255,229,100,0.2));padding-top:0.15em;padding-bottom:0.05em;padding-left:0.2em;padding-right:0.2em;}</style><code class="css-1pnz7gf">item_scraped_count</code>, que mostra quantos itens o spider conseguiu extrair. E aí você pode usar o <code class="css-1pnz7gf">assertTrue</code> para comparar os valores:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token keyword">from</span><span class="token plain"> spidermon </span><span class="token keyword">import</span><span class="token plain"> Monitor</span><span class="token punctuation">,</span><span class="token plain"> MonitorSuite</span><span class="token punctuation">,</span><span class="token plain"> monitors</span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">@monitors</span><span class="token punctuation">.</span><span class="token plain">name</span><span class="token punctuation">(</span><span class="token string">&#x27;Item count&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">ItemCountMonitor</span><span class="token punctuation">(</span><span class="token plain">Monitor</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">    @monitors</span><span class="token punctuation">.</span><span class="token plain">name</span><span class="token punctuation">(</span><span class="token string">&#x27;Minimum number of items&#x27;</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">def</span><span class="token plain"> </span><span class="token function">test_minimum_number_of_items</span><span class="token punctuation">(</span><span class="token plain">self</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        item_extracted </span><span class="token operator">=</span><span class="token plain"> </span><span class="token builtin">getattr</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            self</span><span class="token punctuation">.</span><span class="token plain">data</span><span class="token punctuation">.</span><span class="token plain">stats</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;item_scraped_count&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        minimum_threshold </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">        msg </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;Extracted less than {} items&#x27;</span><span class="token punctuation">.</span><span class="token builtin">format</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            minimum_threshold</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token plain">assertTrue</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            item_extracted </span><span class="token operator">&gt;=</span><span class="token plain"> minimum_threshold</span><span class="token punctuation">,</span><span class="token plain"> msg</span><span class="token operator">=</span><span class="token plain">msg</span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">SpiderCloseMonitorSuite</span><span class="token punctuation">(</span><span class="token plain">MonitorSuite</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">    monitors </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ItemCountMonitor</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span></div></pre><p class="css-1ek8oqb">Crie um arquivo chamado monitors.py e salve esse código.</p><p class="css-1ek8oqb">A ideia é que este MonitorSuite execute após o spider terminar a execução, então o próximo passo é incluir mais uma configuração no settings.py:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token plain">SPIDERMON_SPIDER_CLOSE_MONITORS </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;tutorial.monitors.SpiderCloseMonitorSuite&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span></div></pre><p class="css-1ek8oqb">Agora é só executar o spider normalmente para visualizar os monitores no log.</p><h2 id="validando-itens" class="css-h7w91b"><a href="#validando-itens" aria-label="Validando itens" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Validando itens</h2><p class="css-1ek8oqb">Uma das principais formas de garantir a qualidade dos dados extraídos é validá-los segundo um modelo. Este modelo pode ser definido em um (JSON schema)<!-- -->[https://json-schema.org/]<!-- -->. Entre outras coisas é possível definir os campos obrigatórios dos itens ou usar uma expressão regular para validar o conteúdo de um campo.</p><p class="css-1ek8oqb">Antes de utilizar a validação com o JSON schema, é preciso instalar o pacote <code class="css-1pnz7gf">jsonschema</code>, se já não estiver instalado:</p><pre class="language-bash prism-code language-bash css-1eu4vb7"><div class="token-line"><span class="token plain">$ pip </span><span class="token function">install</span><span class="token plain"> jsonschema</span></div></pre><p class="css-1ek8oqb">Crie um arquivo chamado schema.json na raiz do projeto ou num diretório específico para esses arquivos (só a nível de organização). Nele insira o seguinte código:</p><pre class="language-yaml prism-code language-yaml css-1eu4vb7"><div class="token-line"><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">&quot;$schema&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;object&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token key atrule">&quot;properties&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        &quot;title&quot;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;string&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        &quot;rating&quot;</span><span class="token punctuation">:</span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">            </span><span class="token key atrule">&quot;type&quot;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&quot;number&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    &quot;required&quot;</span><span class="token punctuation">:</span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token string">&quot;rating&quot;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span></div></pre><p class="css-1ek8oqb">Mais algumas configurações são necessárias serem adicionadas ao settings.py. Primeiro, habilite o <code class="css-1pnz7gf">item pipeline</code> e depois adicione o caminho do arquivo criado anteriormente no <code class="css-1pnz7gf">SPIDERMON_VALIDATION_SCHEMAS</code>:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token plain">ITEM_PIPELINES </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;spidermon.contrib.scrapy.pipelines.ItemValidationPipeline&#x27;</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token number">800</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">SPIDERMON_VALIDATION_SCHEMAS </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;/home/anderson/code/crawler_test_spidermon/crawler_test_spidermon/schema.json&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">]</span></div></pre><p class="css-1ek8oqb">O Spidermon vai exibir os erros de <code class="css-1pnz7gf">schema</code> nos <code class="css-1pnz7gf">stats</code> ao final da execução do spider. Se preferir, você pode adicionar os erros de validação nos próprios itens, isto pode facilitar na hora de encontrar o item que está fora do padrão definido. Para isso adicione o seguinte no settings.py:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token plain">SPIDERMON_VALIDATION_ADD_ERRORS_TO_ITEMS </span><span class="token operator">=</span><span class="token plain"> </span><span class="token boolean">True</span></div></pre><h2 id="enviando-notificações-via-telegram" class="css-h7w91b"><a href="#enviando-notificações-via-telegram" aria-label="Enviando notificações via Telegram" class="css-vvm4x1"><svg viewBox="0 0 16 16" width="16" height="16" fill="currentcolor" aria-hidden="true"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Enviando notificações via Telegram</h2><p class="css-1ek8oqb">Esta é outra função bem interessante do Spidermon. Você não precisa ficar checando um spider toda vez que ele finaliza a execução para poder ver se houve algum erro. O Spidermon pode enviar notificações via Email, Slack, Telegram entre outros. Neste artigo vou cobrir o envio de mensagens pelo Telegram, mas a documentação do Spidermon é bem completa com relação aos outros.</p><p class="css-1ek8oqb">Para usar essa funcionalidade, você precisa de um (token de bot)<!-- -->[https://core.telegram.org/bots]<!-- --> do Telegram e adicionar as seguintes opções no settings.py:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token plain">SPIDERMON_TELEGRAM_SENDER_TOKEN </span><span class="token operator">=</span><span class="token plain"> </span><span class="token string">&#x27;&lt;TELEGRAM_SENDER_TOKEN&gt;&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">SPIDERMON_TELEGRAM_RECIPIENTS </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;chatid&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;@channelname&#x27;</span><span class="token punctuation">]</span></div></pre><p class="css-1ek8oqb">A opção <code class="css-1pnz7gf">SPIDERMON_TELEGRAM_RECIPIENTS</code> contém todos os destinatários que irão receber as notificações do Spidermon.</p><p class="css-1ek8oqb">Em seguida, no arquivo monitors.py, importe e adicione a classe que executa a ação de envio de mensagem ao Telegram:</p><pre class="language-python prism-code language-python css-1eu4vb7"><div class="token-line"><span class="token keyword">from</span><span class="token plain"> spidermon</span><span class="token punctuation">.</span><span class="token plain">contrib</span><span class="token punctuation">.</span><span class="token plain">actions</span><span class="token punctuation">.</span><span class="token plain">telegram</span><span class="token punctuation">.</span><span class="token plain">notifiers </span><span class="token keyword">import</span><span class="token plain"> SendTelegramMessageSpiderFinished</span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">class</span><span class="token plain"> </span><span class="token class-name">SpiderCloseMonitorSuite</span><span class="token punctuation">(</span><span class="token plain">MonitorSuite</span><span class="token punctuation">)</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain css-1baulvz"></span></div><div class="token-line"><span class="token plain">    monitors </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        ItemCountMonitor</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    monitors_failed_actions </span><span class="token operator">=</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">SendTelegramMessageSpiderFinished</span><span class="token punctuation">]</span></div></pre><p class="css-1ek8oqb">Pronto, se houver algum erro definido nos monitores, a notificação será enviada via Telegram para todos os destinatários.</p></section></article></main><style data-emotion-css="1i8tjli">.css-1i8tjli{margin-top:32px;padding-top:16px;}</style><footer class="css-1i8tjli"><style data-emotion-css="1u77lb1">.css-1u77lb1{border-color:var(--theme-ui-colors-muted,hsla(0,0%,0%,0.2));}</style><hr class="css-1u77lb1"/><style data-emotion-css="j6r63x">.css-j6r63x{margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><style data-emotion-css="u5xevn">.css-u5xevn{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin-bottom:32px;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}</style><div class="css-u5xevn"><style data-emotion-css="1emx3y6">.css-1emx3y6{margin-right:8px;margin-bottom:0;width:48px;min-width:48px;border-radius:99999px;}</style><div class="css-1emx3y6 gatsby-image-wrapper" style="position:relative;overflow:hidden;display:inline-block;width:48px;height:48px"><img aria-hidden="true" src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGQABAAIDAAAAAAAAAAAAAAAAAAIDAQQF/8QAFgEBAQEAAAAAAAAAAAAAAAAAAQIA/9oADAMBAAIQAxAAAAHm36c5qStphkWsJ//EABwQAAICAgMAAAAAAAAAAAAAAAECAAMQERIxQf/aAAgBAQABBQJWcmxQqzepZZywe/J//8QAFREBAQAAAAAAAAAAAAAAAAAAICH/2gAIAQMBAT8Bg//EABURAQEAAAAAAAAAAAAAAAAAACAh/9oACAECAQE/AaP/xAAbEAEAAAcAAAAAAAAAAAAAAAABAAIQESAhcf/aAAgBAQAGPwIHcXlF7i1//8QAGxAAAwEBAAMAAAAAAAAAAAAAAAERMSEQUXH/2gAIAQEAAT8hkerc6qaYWBusTtfWGFLhbg9+xPH/2gAMAwEAAgADAAAAEHgYgP/EABYRAQEBAAAAAAAAAAAAAAAAAAEQEf/aAAgBAwEBPxAwMJ//xAAXEQEBAQEAAAAAAAAAAAAAAAABEBEx/9oACAECAQE/EHSQ5P/EABwQAQEBAQACAwAAAAAAAAAAAAERACExYUFRcf/aAAgBAQABPxBqgnEp+5NECiAeyfOJbb6z9EfJ7+9CODF5KmF0hDnWZq296KZ2+dXf/9k=" alt="Anderson Berg" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/c32652ec49cd299c1b99dc17481ed005/ffcc9/avatar.jpg 1x,
/static/c32652ec49cd299c1b99dc17481ed005/3e51d/avatar.jpg 1.5x,
/static/c32652ec49cd299c1b99dc17481ed005/eee8e/avatar.jpg 2x" /><img loading="lazy" width="48" height="48" srcset="/static/c32652ec49cd299c1b99dc17481ed005/ffcc9/avatar.jpg 1x,
/static/c32652ec49cd299c1b99dc17481ed005/3e51d/avatar.jpg 1.5x,
/static/c32652ec49cd299c1b99dc17481ed005/eee8e/avatar.jpg 2x" src="/static/c32652ec49cd299c1b99dc17481ed005/ffcc9/avatar.jpg" alt="Anderson Berg" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="css-0">Desenvolvedor Python</div></div><style data-emotion-css="11r1i3o">.css-11r1i3o{-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><style data-emotion-css="15qbtrw">.css-15qbtrw{box-sizing:border-box;margin:0;min-width:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:justify;-webkit-justify-content:space-between;-ms-flex-pack:justify;justify-content:space-between;list-style:none;padding:0;}</style><ul class="css-15qbtrw"><li><a rel="prev" class="css-o7eq5i" href="/aprendendo-a-aprender/">← <!-- -->Aprendendo a Aprender</a></li><li><a rel="next" class="css-o7eq5i" href="/pandas-groupby/">Pandas Groupby<!-- --> →</a></li></ul></footer></div></div></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/como-monitorar-spiders-spidermon/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-eb0d07966faded618939.js"],"app":["/app-daa015120a5471449e2c.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-0edab85ce55c0548d50d.js"],"component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js":["/component---node-modules-gatsby-theme-blog-core-src-templates-posts-query-js-17f0fa5daef5072954f2.js"]};/*]]>*/</script><script src="/polyfill-eb0d07966faded618939.js" nomodule=""></script><script src="/webpack-runtime-38ea2b586afb87ab3a8f.js" async=""></script><script src="/framework-3e6dec6139dadaa7d0c7.js" async=""></script><script src="/commons-e4855faf0c374b89b985.js" async=""></script><script src="/app-daa015120a5471449e2c.js" async=""></script><script src="/component---node-modules-gatsby-theme-blog-core-src-templates-post-query-js-0edab85ce55c0548d50d.js" async=""></script><script src="/styles-9411612e31e4f14527d1.js" async=""></script></body></html>